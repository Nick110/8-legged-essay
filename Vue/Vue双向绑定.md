
# Vue双向绑定的理解

> 一句话说：vue双向数据绑定原理是通过 `数据劫持` 结合 `发布订阅模式` 的方式来实现的。


## v-model 
v-model是v-on和v-bind的结合指令，v-on事件监听，v-bind实现数据到视图的单项绑定
v-on绑定了表单元素的input事件

## 数据劫持
什么是数据劫持？
它通过监听数据的变化来自动更新视图，同时也可以反过来，通过监听视图的变化来更新数据（Vue2.x使用的是 `Object.defineProperty` ,Vue3.x使用的是Es6中的 `Proxy` 方法）。

## 发布订阅模式
发布订阅模式是一种消息范式，包含一个主题/事件中心，通常会有多个订阅者，当主题对象发布事件时，订阅者对象会收到事件通知，然后进行相应的处理。
类似于一家报社发布报纸，读者可以订阅，当新的报纸发布时，读者就会收到通知。这种模式可以实现松散耦合，订阅者不需要知道谁发布了事件，发布者也不需要知道谁订阅了事件，从而使代码更灵活、可复用和易于维护。


## 主要构成
监听器 (Observer) : 观察数据，时刻关注数据的任何变化，通知视图更新；
解析器 (Compiler) ：观察视图层，时刻关注视图发生的一切交互，更新数据；



## 双向数据绑定实现步骤

1. 首先在 VUE 初始化的时候，对数据(data)进行劫持监听（响应化处理），需要设置一个监听器`（Observer）`, 用来监听所有属性。
监听器中使用到了ES5中的 `Object.defineProperty()` 方法，该方法能够劫持对象的 `setter 和 getter`方法，已达到监听数据的效果。getter添加订阅者Watcher，setter发布通知


2. 对模版执行编译操作，需要一个 指令解析器`（Compile）`，对每个节点元素进行扫描和解析（元素节点/文本节点）。
找到其中动态绑定的数据，从 data 中获取并初始化视图。
同时，初始化一个 订阅者`（Watcher）`并添加更新函数，将来数据变化时 `Watcher` 会调用更新函数。


3. 由于数据data中的key在一个视图中可能出现多次，订阅者会有多个，所以需要一个 消息订阅器`（Dep）`来专门收集这些订阅者，进行统一管理。


4. 如果data中的属性发生了变化，会先找到对应的消息订阅器`（Dep）`, 通知所有的 订阅者`（Watcher）`执行更新函数。

![image](https://github.com/Nick110/8-legged-essay/assets/30553189/f75a572f-7d63-404d-8be2-494d212c33c4)




### 实现双向数据绑定可以归纳为以下3个步骤：


1. 实现一个监听器 Observer, 用来劫持并监听所有属性，如果有变动，就通知订阅者。


2. 实现一个订阅者 Watcher, 可以收到属性的变化通知并执行相应的函数，从而更新视图。
a.  订阅者可能有多个，需要一个订阅收集器来统一管理，在observer-get中，给每个属性赋值时，会初始化一个 Dep类，用来收集和发布订阅者


4. 实现一个解析器 Compile, 可以扫描和解析每个节点的相关指令，并根据初始化模版数据以及初始化相应的订阅器




## 参考：[对双向数据绑定原理的理解及代码模拟 | Vue - 掘金](https://juejin.cn/post/7242519176853356601?searchId=20231111210346F66FD34567E67C081367)
